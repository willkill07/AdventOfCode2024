
module;

#include <algorithm>
#include <functional>
#include <ranges>
#include <string_view>

#include <ctre.hpp>

export module day21;

constexpr static std::size_t N{11};

// clang-format off
constexpr static std::array lut3{
  1LU,  25LU, 12LU, 19LU, 26LU, 13LU, 20LU, 27LU, 14LU, 21LU, 10LU,
  21LU, 1LU,  10LU, 11LU, 12LU, 19LU, 20LU, 13LU, 20LU, 21LU, 22LU,
  16LU, 18LU, 1LU,  10LU, 21LU, 12LU, 19LU, 22LU, 13LU, 20LU, 17LU,
  21LU, 19LU, 18LU, 1LU,  22LU, 21LU, 12LU, 23LU, 22LU, 13LU, 16LU,
  22LU, 16LU, 17LU, 18LU, 1LU,  10LU, 11LU, 12LU, 19LU, 20LU, 23LU,
  17LU, 21LU, 16LU, 17LU, 18LU, 1LU,  10LU, 21LU, 12LU, 19LU, 18LU,
  22LU, 22LU, 21LU, 16LU, 19LU, 18LU, 1LU,  22LU, 21LU, 12LU, 17LU,
  23LU, 17LU, 18LU, 19LU, 16LU, 17LU, 18LU, 1LU,  10LU, 11LU, 24LU,
  18LU, 22LU, 17LU, 18LU, 21LU, 16LU, 17LU, 18LU, 1LU,  10LU, 19LU,
  23LU, 23LU, 22LU, 17LU, 22LU, 21LU, 16LU, 19LU, 18LU, 1LU,  18LU,
  18LU, 26LU, 21LU, 12LU, 27LU, 22LU, 13LU, 28LU, 23LU, 14LU, 1LU
};

constexpr static std::array lut26{
  1LU, 31420065369LU, 14752615084LU, 24095973437LU, 31420065370LU, 14752615085LU, 24095973438LU, 31420065371LU, 14752615086LU, 24095973439LU, 14287938116LU,
  27052881363LU, 1LU, 14287938116LU, 14287938117LU, 14752615084LU, 24095973437LU, 24095973438LU, 14752615085LU, 24095973438LU, 24095973439LU, 27052881364LU,
  20790420654LU, 22411052532LU, 1LU, 14287938116LU, 28154654777LU, 14752615084LU, 24095973437LU, 28154654778LU, 14752615085LU, 24095973438LU, 22778092491LU,
  27622800565LU, 22411052533LU, 22411052532LU, 1LU, 28154654778LU, 28154654777LU, 14752615084LU, 28154654779LU, 28154654778LU, 14752615085LU, 20790420654LU,
  27052881364LU, 20790420654LU, 22778092491LU, 22778092492LU, 1LU, 14287938116LU, 14287938117LU, 14752615084LU, 24095973437LU, 24095973438LU, 27052881365LU,
  20790420655LU, 27622800565LU, 20790420654LU, 22778092491LU, 22411052532LU, 1LU, 14287938116LU, 28154654777LU, 14752615084LU, 24095973437LU, 22778092492LU,
  27622800566LU, 27622800566LU, 27622800565LU, 20790420654LU, 22411052533LU, 22411052532LU, 1LU, 28154654778LU, 28154654777LU, 14752615084LU, 20790420655LU,
  27052881365LU, 20790420655LU, 22778092492LU, 22778092493LU, 20790420654LU, 22778092491LU, 22778092492LU, 1LU, 14287938116LU, 14287938117LU, 27052881366LU,
  20790420656LU, 27622800566LU, 20790420655LU, 22778092492LU, 27622800565LU, 20790420654LU, 22778092491LU, 22411052532LU, 1LU, 14287938116LU, 22778092493LU,
  27622800567LU, 27622800567LU, 27622800566LU, 20790420655LU, 27622800566LU, 27622800565LU, 20790420654LU, 22411052533LU, 22411052532LU, 1LU, 20790420656LU,
  22411052532LU, 31420065370LU, 28154654777LU, 14752615084LU, 31420065371LU, 28154654778LU, 14752615085LU, 31420065372LU, 28154654779LU, 14752615086LU, 1LU
};
// clang-format on

[[nodiscard]] constexpr unsigned Encode(char c) noexcept {
  unsigned const o{static_cast<unsigned>(c)};
  return (o & 0xF) + (o >> 6) * 9;
}

export using Day21ParsedType = std::array<std::size_t, N * N>;
export using Day21AnswerType = std::size_t;

export Day21ParsedType Day21Parse(std::string_view input) noexcept {
  std::array<std::size_t, N * N> counts;
  counts.fill(0);
  input.remove_suffix(1);
  for (auto line : ctre::split<"\n">(input)) {
    auto num_str = line.view();
    num_str.remove_suffix(1);
    std::size_t num;
    std::from_chars(num_str.begin(), num_str.end(), num);
    for (unsigned last{Encode('A')}; unsigned curr : std::views::transform(line, Encode)) {
      counts[last * N + curr] += num;
      last = curr;
    }
  }
  return counts;
}

export Day21AnswerType Day21Part1(Day21ParsedType const& c) noexcept {
  return std::ranges::fold_left(std::views::zip_transform(std::multiplies{}, c, lut3), 0LU, std::plus{});
}

export Day21AnswerType Day21Part2(Day21ParsedType const& c, [[maybe_unused]] Day21AnswerType const& answer) {
  return std::ranges::fold_left(std::views::zip_transform(std::multiplies{}, c, lut26), 0LU, std::plus{});
}
